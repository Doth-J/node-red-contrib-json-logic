<script type="text/javascript" id="node-logic_engine">
    RED.nodes.registerType('logic_engine',{
        category: 'config',
        defaults: {
            name:{value:""},
            methods:{value:""},
        },
        oneditprepare:()=>{
            this.editor = RED.editor.createEditor({
                id: 'node-input-methods-editor',
                mode: 'ace/mode/nrjavascript',
                value: $("#node-config-input-methods").val(),
            });
            $("#node-input-methods-editor").css('height', '375px');
            editor.resize();
            editor.getSession().on('change', function(){
                $("#node-config-input-methods").val(editor.getSession().getValue());
            });
        },
        oneditsave: function() {
            $("#node-config-input-methods").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        label: function() {
            return this.name || "Logic Engine"
        }
    });
</script>

<script type="text/html" data-template-name="logic_engine">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name: </label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <div style="display:flex;align-items:start;gap:5px">
            <label for="node-config-input-methods" style="width: auto;"><i class="fa fa-plus-circle"></i> Methods:</label>
            <input type="hidden" id="node-config-input-methods">
        </div>
        <div id="methods" style="width: 100%; display: flex;flex-direction: column;gap: 5px;">
            <a target="_blank" href="https://jessemitchell.me/json-logic-engine/docs/methods" style="display:flex;background-color: #011627;border-radius:5px;padding:1px">
                <div style="padding-left:2px;display:flex;width:62px;justify-content:center;font-variant-numeric:tabular-nums;color:#d6deeb">0</div>
                <div><code><span style="color: rgb(127, 219, 202);">const</span> <span style="color:#d6deeb">engine</span> <span style="color:rgb(127, 219, 202)">= new</span> <span style="color: rgb(255, 203, 139);">LogicEngine</span><span style="color: rgb(199, 146, 234);">()</span></code></div>
            </a>
            <div class="node-text-editor" id="node-input-methods-editor"></div>
            <div id="node-config-input-methods-hint" style="padding:2px;font-size:10px;width:100%;font-style: italic;">
                <i class="fa fa-question-circle-o"></i> Access the <b>LogicEngine</b> instance via the <code>engine</code> variable.
            </div>
        </div>
    </div>
</script>

<script type="text/javascript" id="node-logic">
    RED.nodes.registerType('jsonlogic',{
        category:'function',
        color:'#008ECC',
        icon:'logic.svg',
        inputs:1,
        inputLabels: "data",
        paletteLabel:"logic",
        outputs:2,
        outputLabels: ["pass","fail"],
        defaults: {
            name: {value:''},
            engine: {value:"", type:"logic_engine"},
            mode: {value:'rule'},
            data: {value:'payload',required:true},
            dataType: {value:'msg'},
            rule: {value:'',required:true},
            ruleType: {value:'json'},
            checkpoint:{value:false},
            checkpointMessage:{value:""},
            outputs:{value:2}
        },
        oneditprepare:()=>{
            $("#node-input-mode").typedInput({
                types:[
                    {
                        options:[
                            {value:"rule", label:'Rule'},
                            {value:"operator", label:'Operator'}
                        ]
                    }
                ]
            })
            $("#node-input-checkpoint").change(()=>$("#node-input-checkpoint").is(":checked") ? $("#node-input-checkpoint-hint").show() : $("#node-input-checkpoint-hint").hide());
            $("#node-input-mode").change(()=>{
                switch($("#node-input-mode").val()){
                    case "rule":{
                        $("#mode-desc").html(' Rule(s)')
                        $("#node-input-outputs").val(2)
                        break;
                    }
                    case "operator":{
                        $("#mode-desc").html(' Operation(s)')
                        $("#node-input-outputs").val(1)
                        break;
                    }
                }
            })
            $("#node-input-rule").typedInput({
                types: ["json","msg","flow","global","env"],
                typeField: "#node-input-ruleType"
            })
            $("#node-input-data").typedInput({
                types: ["msg","flow","global"],
                typeField: "#node-input-dataType"
            })
        },
        label: function(){
            return this.name || this.mode
        }
    });
</script>
<script type="text/html" data-template-name="jsonlogic">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name: </label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-engine"><i class="fa fa-gear"></i> Engine: </label>
        <input type="text" id="node-input-engine" placeholder="Engine">
    </div>
    <div class="form-row">
        <label for="node-input-mode"><i class="fa fa-codepen"></i> Mode:</label>
        <input type="text" id="node-input-mode">
        <input type="hidden" id="node-input-outputs">
    </div>
    <div class="form-row">
        <label for="node-input-rule"><i class="fa fa-check-circle"></i><span id="mode-desc">Rule(s):</span></label>
        <input type="text" id="node-input-rule">
        <input type="hidden" id="node-input-ruleType">
    </div>
    <div class="form-row">
        <label for="node-input-data"><i class="fa fa-dot-circle-o"></i> Data:</label>
        <input type="text" id="node-input-data">
        <input type="hidden" id="node-input-dataType">
    </div>
    <div class="form-row">
        <div style="display:flex;align-items:start;gap:5px">
            <label for="node-input-checkpoint"><i class="fa fa-flag"></i> Checkpoint:</label>
            <input  style="width: auto;" type="checkbox" id="node-input-checkpoint">
        </div>
        <div id="node-input-checkpoint-hint" style="display:flex;flex-direction:column;gap:5px;line-height:normal;font-size:13px;width:100%;font-style: italic;">
            <div style="display: flex; gap:10px;align-items: center;">
                <p style="margin: 0;gap: 5x;"><i class="fa fa-comment"></i></p>
                <input style="width: auto;" type="text" id="node-input-checkpointMessage" placeholder="Message">
            </div>
            <div style="display: flex; gap:5px">
                <i class="fa fa-plus"></i> Append checkpoint to <code>msg.checkpoints</code>.
            </div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="jsonlogic">
    <p>Logic Node-RED node</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
    <dt>payload
        <span class="property-type">json</span>
    </dt>
    <h3>Outputs</h3>
    <dl class="message-properties">
    <dt>payload
        <span class="property-type">json</span>
    </dt>
    <dt>checkpoints
        <span class="property-type">array[]</span>
    </dt>
    <h3>Details</h3>
    <p>This node implements json-logic for creating rules and evaluating data.</p>
</script>